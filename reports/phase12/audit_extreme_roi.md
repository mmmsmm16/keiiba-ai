# Phase 12 監査報告: 極端なROIの原因調査

## エグゼクティブサマリ
2025年の「Fast Mode」最適化計算において、**ROI 656%** という統計的にあり得ない数値が算出されました。本監査は、この異常値の原因を特定するために実施されました。

**結論: リーク（未来情報の混入）が確定**
この高ROIは、**リークされた未来情報**（主に `v13_oof` の予測値、およびオッズデータそのもの）に基づいてシグナル処理が行われた結果であることが判明しました。「Placebo（偽薬）」テストはパスしたため（ROI < 100%）、払戻計算ロジック自体にバグ（無限にお金が増えるバグ等）はありません。しかし、「Market Sanity（市場整合性）」テストで **ROI 242%** を記録したことは、使用しているオッズデータ自体が「確定オッズ（Final Odds）」またはそれに近い未来の情報を含んでいることを強く示唆しています。

## 監査結果 (2025年1月)

| モード | コスト (円) | 払戻 (円) | 利益 (円) | ROI (%) | 解釈 |
|---|---|---|---|---|---|
| **Normal (通常)** | 2,298,100 | 15,024,890 | 12,726,790 | **653.8%** | 当初の異常値を再現。 |
| **Placebo (シャッフル)** | 2,288,400 | 1,052,250 | -1,236,150 | **46.0%** | **PASS.** 予測値をランダムにしても利益は出ない。計算ロジックは正常に「負け」を判定できている。 |
| **Market Sanity (オッズ逆数)** | 457,000 | 1,109,510 | 652,510 | **242.8%** | **FAIL.** オッズ情報のみ（予測モデル不使用）で ROI 242% は異常。通常は控除率の影響で 75-80% になるはずである。これは、使用した「T-10オッズ」が実際には未来の「確定オッズ」であることを意味する。 |

## 詳細分析

### 1. 払戻ロジック検証 (Placebo Test)
- **手法**: レース内で `pred_prob` をランダムにシャッフルして実行。
- **結果**: ROI は 46% に低下。
- **所見**: シグナルがノイズであれば正しく損失が発生しており、計算エンジンの健全性は確認された。

### 2. オッズ/市場リーク検証 (Market Sanity Test)
- **手法**: `pred_prob = 0.8 / odds` と設定し、モデル予測を使わずオッズのみで賭ける（市場追随）。
- **結果**: ROI 242%。
- **所見**: これが「オッズリーク」の決定的な証拠である。オッズに従うだけでプラスになるのは、「過小評価された本命」や「過大評価された穴馬」をレース前に完全に見抜けている（＝確定結果を知っている）場合にしか起こり得ない。
    - 本当に T-10 時点のオッズであれば、この戦略は ROI 80% 前後に収束するはずである。

### 3. モデルリーク
- Normalモード (653%) が Market Sanity (242%) よりもさらに高いことは、`v13_oof` の予測値にも、オッズリーク以上の未来情報が含まれている（あるいはオッズ情報のリーク信号を増幅している）ことを示唆している。

## オッズデータの現状
現在使用している `data/odds_snapshots/2025/odds_T-10.parquet` の生成ロジック (`build_time_series_odds.py`) に重大な欠陥がある可能性が高い。タイムスタンプフィルタリングが機能しておらず、確定オッズを取得してしまっていると思われる。

## 次のステップ
1. **`odds_T-10.parquet` の調査**: 生データを確認し、確定オッズと一致するか確認する。
2. **`build_time_series_odds.py` の修正**: タイムスタンプ判定ロジックを修正し、重複排除を追加する。
3. **スナップショット再生成**: 正しい T-10 オッズを作成する。
4. **再監査**: Market Sanity が 80% 前後、Normal が現実的な値に落ちることを確認する。
