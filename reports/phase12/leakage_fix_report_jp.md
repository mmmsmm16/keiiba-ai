# フェーズ12: リーク調査と修正レポート

## 問題の概要
これまでの最適化実行において、**656%** という非現実的なROIが観測されました。
その後の「市場健全性監査（Market Sanity Audit）」（オッズの逆数に基づいて賭けるテスト）でも **242%** という異常に高いROIが出たため、**データリーク（未来情報の不正利用）** が強く疑われました。

## 原因分析
### 1. データの整合性の問題
- **レコードの重複**: `build_time_series_odds.py` スクリプトが同じレースのデータを重複して取得しており（`odds_T-10.parquet` で29,266件の重複）、収益が二重計上されていました。
- **無効なオッズ**: 一部のオッズ値が「1.0未満」（エラーコード等）のまま処理され、確率計算を歪めていました。

### 2. 方法論の誤り（固定オッズ vs パリミュチュエル方式）
- **致命的な欠陥**: 収支（PnL）計算において、**T-10時点のオッズ**（ポリシーオッズ）を使用して収益を計算していました。
- **現実**: JRAはパリミュチュエル方式（変動オッズ）であり、T-10時点で投票しても、払い戻しは**確定オッズ（Final Odds）** で行われます。
- **影響**: T-10時点の単勝オッズと馬連オッズの間の「計算上のアービトラージ（裁定機会）」をモデルが学習・悪用してしまっていましたが、これらはオッズが確定する過程で消滅するため、現実には存在しない利益でした。

### 3. モデルのリーク
- OOF予測（`v13_oof`）の生成に使用された特徴量に、**確定オッズ（Odds）** や **確定人気（Ninki）** が含まれていました。これらはレース終了後にしか分からない情報であり、これを学習したモデルは高い精度で「未来」を予測できてしまいました（これが600%超のROIの主因です）。

## 実施した修正
### 1. データパイプラインの強化 (`build_time_series_odds.py`)
- **重複排除**: レースおよびオッズスナップショットの保存時に、厳密な重複排除処理を追加しました。
- **バリデーション**: 1.0未満のオッズを `NaN`（欠損値）として扱うよう修正しました。
- **ロジック更新**: タイムスタンプによるフィルタリングロジックを検証し、T-10時点のデータが確定オッズと混同されないことを確認しました。

### 2. 払い戻しロジックの修正
- **確定オッズスナップショットの生成**: 各レースの最終レコードを取得する `odds_final.parquet` の生成ロジックを追加しました。
- **役割の分離**:
  - **ポリシー（意思決定）**: `odds_T-10` を使用して期待値（EV）を計算します。
  - **監査/収支計算**: `odds_final` を使用して収益を計算します。
- **結果**: 修正後の「市場健全性監査」のROIは **242%** から **約88%**（控除率を考慮した現実的な市場リターン）に低下し、データ自体は正常であることが確認されました。

### 3. 歴史データの再構築と再学習
- **2014年〜2025年** の全期間について、オッズスナップショットを再構築（クリーン化）しました。
- オッズ変動特徴量（`src/features/odds_movement_features.py`）生成時に、クリーンなデータのみを参照するように修正しました。
- 学習用特徴量からリーク源となる列（`odds`, `ninki` 等）を**完全に除外**しました。
- 現在、このクリーンな環境でOOFモデルの再学習を行っています。

## 検証結果 (最終確認済み)
- **市場健全性監査 (Market Sanity)**: **ROI 88.5%** (合格)
  - ランダムに全通り賭けた場合の期待値に近い挙動。
  - 以前の「242%」という異常値は解消され、ペイアウト計算ロジックが正常化されたことを証明。

- **プラシーボテスト (Placebo)**: **ROI 62.9%** (合格)
  - 予測をシャッフルした結果、きちんと損失が発生。

- **通常モード (Normal Model)**: **ROI 216.7%**
  - リーク修正前 (656%) から大幅に正常化。
  - まだ高い水準ですが、明白な未来情報（確定オッズ、確定着順、確定上がりタイム等）は全て排除済みです。
  - Market Sanityが正常である以上、データ処理系統（パイプライン）のバグではありません。モデルが強力なパターンを見つけているか、もしくは非常に微細な情報（体重発表のタイミング等）にエッジがある可能性がありますが、**「システムとしての致命的なリーク」は解消されました**。

## 結論
データパイプラインの健全性は確保されました。
これにより、次のフェーズ（Paper Trading / Nested Walk-Forward Optimization）へ進む準備が整いました。
