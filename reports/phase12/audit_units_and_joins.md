# Phase 12 監査報告: 単位および結合整合性

## サマリ
`audit_extreme_roi.md` で確認されたROIリークに加え、本監査では `odds_T-10.parquet` における **重大なデータ整合性の問題** が特定されました。

**ステータス: FAIL (不合格)**

## 調査結果

### 1. キーの重複 (Duplicate Keys)
- **件数**: `(race_id, ticket_type, combination)` の組み合わせにおいて、**29,266件** の重複が見つかりました。
- **影響**: 最適化ループ内の `pd.merge` 処理において、同一チケットに対して複数の候補行が生成されてしまいます。これにより以下の問題が発生します：
    - **二重投資**: 最適化エンジンが同一の高EVチケットを複数回認識し、本来の制限を超えて資金を配分してしまいます。
    - **ROIの過大評価**: 重複したチケットが的中した場合、払戻金（Revenue）も二重、三重に計上されます。

### 2. オッズ値の範囲 (Odds Value Range)
| 券種 | 件数 | 平均 | 最小 (Min) | 最大 (Max) | 問題点 |
|---|---|---|---|---|---|
| **Win (単勝)** | 45,011 | 42.9 | 1.1 | 509.3 | 概ね正常。 |
| **Place (複勝)** | 45,011 | 6.1 | 1.0 | 72.5 | 概ね正常。 |
| **Umaren (馬連)** | 282,865 | 250.3 | **0.1** | 999.3 | **不正な最小値 (0.1)**。1.0未満のオッズはあり得ない。999.3 は表示上限による切り捨ての可能性あり。 |
| **Wakuren (枠連)** | 64,304 | 339.0 | **0.1** | 993.6 | **不正な最小値 (0.1)**。 |

- **0.1 オッズ**: データ欠損やエラーのプレースホルダである可能性が高いです。高確率と予測された場合にこれらを有効な投資対象とみなすと、EV計算が不正になります（本来除外すべき）。
- **999.3 最大値**: JRAのオッズ表示上限（999.9等）に張り付いている可能性があります。

## 結論
記録された 656% という ROI は、以下の **「複合的な要因（Perfect Storm）」** によって引き起こされました：
1.  **リーク**: T-10 オッズの実体が「確定オッズ」である可能性が高い（Market Sanity ROI 242%）。
2.  **重複**: 的中チケットが複数回カウントされ、利益が増幅された（Multiplier Effect）。
3.  **モデルリーク**: `v13_oof` のシグナル強度が異常に強い（Normal ROI > Market Sanity）。

## 必須の修正アクション
1.  **重複排除**: `build_time_series_odds.py` にてデータの重複を削除する。
2.  **タイムスタンプ修正**: `build_time_series_odds.py` のフィルタリングロジックを見直し、厳密に T-10 時点（確定オッズではない）を取得するようにする。
3.  **予測値の再検証**: `v13_oof` の特徴量に未来情報が含まれていないか再確認する。
