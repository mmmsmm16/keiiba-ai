# セッション引継ぎ資料: Phase 9 複勝・ワイド戦略検証

## 1. セッションの目的
v12 (Win Specialist) モデルの予測力を活用し、単勝以外の馬券種（複勝・ワイド）における収益性を検証すること。

## 2. 実施した主な内容

### A. 推論プロセスの堅牢化 (Debugging Model Inference)
v12 モデルの推論時に発生していた型不一致エラーを解消しました。
- **LightGBM**: カテゴリカル特徴量を `pd.factorize()` で数値化し、`np.float32` 配列としてモデルに渡す方式に統一。
- **CatBoost**: 数値カテゴリ（`age` 等）を `int` 経由で `str` に変換し、`NaN` を `'None'` に置換。これにより、モデルが学習時に記憶している文字列形式との不一致を解消。
- **特徴量補完**: 学習時に使用されていた `year` 特徴量を `date` カラムから復元。

### B. 配当データマッピングの確立 (JRA-VAN `jvd_hr` Parsing)
PC-KEIBAスキーマの配当テーブルの仕様を特定し、シミュレーション精度を向上させました。
- **複勝**: `haraimodoshi_fukusho_Xa` が馬番、`Xb` が配当額であることを実データから特定。
- **ワイド**: `haraimodoshi_wide_Xa` に格納されている 4 桁結合文字（例: "0714" -> 7番と14番）を分解するパースロジックを実装。
- **Race ID**: 12 桁の固定文字列形式 (`YYYYVVKKNNDD`) に統一し、予測データと配当データの結合を確実に。

### C. 戦略シミュレーションの実行 (2025年テストデータ)
以下の結果を得ました。

| 戦略 | ROI | 的中率 | 分析・知見 |
| :--- | :--- | :--- | :--- |
| **Place ModelRank1** | **77.4%** | **51.3%** | 単勝 (71.3%) より高い収益性と安定性を確認。 |
| **Wide Top 1-5 Box** | 71.9% | - | 控除率を考慮すると妥当な基準値。 |
| **Place EV > 1.0** | 64.9% | - | 全頭ベタ買いに近い状態では収益性が低下。 |

## 3. 作成・更新した主要ファイル
- `scripts/adhoc/run_v9_multi_ticket_sim.py`: 複勝・ワイドの統合シミュレータ。
- `scripts/adhoc/run_v9_comparison.py`: 同一推論結果に基づく単複 ROI 比較スクリプト。
- `scripts/adhoc/inspect_v12_model.py` / `inspect_v12_cat_model.py`: モデル内部メタデータの確認用。

## 4. 次回セッションへの課題・提案
1. **Gap分析の深化**: 
   - 「モデル評価1位 × 市場評価5位以下（高配当）」といった、期待値の歪み（Gap）が大きいセグメントでの複勝投資を深掘りする。
2. **リアルタイムオッズの統合**: 
   - 今回確立したマッピングロジックを `src/data/realtime_loader.py` と連携させ、10分前オッズによるワイド EV 計算を自動化する。
3. **P(Top3) キャリブレーションの再評価**: 
   - Isotonic Regression による変換モデルの精度向上（特定の競馬場や馬場状態での偏りの有無）。

---
**Status**: 調査基盤の構築と初期評価が完了。ROI 100% 突破のための個別セグメント探索フェーズへ。
