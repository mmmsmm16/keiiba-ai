
# M5: アンサンブル & 最終化 報告書

**評価モード**: ADHOC (Split Pipeline)
**日付**: 2025-12-22
**特徴量セット**: M4-B (Core + クラス統計)

## 目的
Win（1着）、Top2（2着以内）、Top3（3着以内）の3つのバイナリ分類モデルを統合し、ランキングのための単一の最適化スコアを生成することで、Phase M の性能を最終化する。

## モデル & 確率校正
全てのモデルは **M4-B (Core + クラス統計)** 特徴量セットと **時系列減衰 (Piecewise Time Decay)** を用いて学習されています（2015-2023年を学習、2024年を検証に使用）。
予測確率は、5-fold OOF（Out-Of-Fold）予測に基づき、**Platt Scaling（Sigmoid）** を用いて校正されています。

| コンポーネント | ターゲット | AUC (検証) | Brier (検証) |
|---|---|---|---|
| **M5-Win** | 1着 | 0.7376 | 0.0725 |
| **M5-Top2** | 2着以内 | 0.7323 | 0.1259 |
| **M5-Top3** | 3着以内 | 0.7242 | 0.1655 |

## アンサンブル評価 (2024年全体)

| 戦略 | NDCG@5 | Recall@5 | Race-Hit@5 | Precision@5 |
|:---|---:|---:|---:|---:|
| **M4-B 単体 (ベースライン)** | 0.5601 | 0.6590 | 0.9669 | 0.3944 |
| **M5-Win 単体** | 0.5973 | 0.6641 | 0.9699 | 0.3981 |
| **M5-Top2 単体** | 0.6024 | 0.6686 | 0.9707 | 0.4008 |
| **M5-Top3 単体** | 0.6008 | 0.6691 | 0.9735 | 0.4011 |
| **Ensemble-Avg (単純平均)** | 0.6042 | **0.6704** | 0.9728 | **0.4019** |
| **Ensemble-W1 (Win 重視)**| **0.6047** | 0.6700 | 0.9726 | 0.4016 |

### 分析
1.  **アンサンブルによる向上**: 単一の Top3 バイナリモデルから、Win/Top2/Top3 のターゲットを統合したアンサンブルへ移行することで、NDCG@5 が **+4.4pt**、Recall@5 が **+1.1pt** 改善しました。
2.  **Top2/Top3 の精度**: Top2 および Top3 の単体モデルだけでも M4-B ベースラインを上回りました。これは、より深い学習データ（2015-2023年）と適切な確率校正の効果と考えられます。
3.  **最適戦略**: `Ensemble-W1`（重み: 0.5, 0.3, 0.2）が最高のランキング品質（NDCG）を記録した一方、`Ensemble-Avg` はわずかに高いカバー率（Recall）を示しました。

## セグメント別性能 (Ensemble-Avg)
- **小頭数レース (<= 10頭)**: Recall@5 **0.7562**, NDCG@5 **0.6807**
- **マイル戦 (1400-1800m)**: Recall@5 **0.6700**, NDCG@5 **0.6016**

## 結論
**アンサンブル (Win+Top2+Top3)** アプローチを採用し、**単純平均** または **重み付けスコアリング** を使用します。これにより、3着以内に入る馬（Top 3）のランキングにおいて、最も堅牢で正確な予測が可能になります。

最終的な M5 パフォーマンス: **Recall@5: 0.670, NDCG@5: 0.604**
M3 ベースライン（Recall 0.606）との比較: **+6.4pt の改善**
