# Phase 18: Advanced Domain Features 実施報告書

## 1. フェーズの目的
本フェーズ（Phase 18）の主な目的は、競馬予測における「ドメイン知識」を高度な特徴量としてモデルに組み込み、予測精度の向上（特にROIの改善）を図ることでした。また、過去のバックテストで課題となっていた「データリーク（未来情報の混入）」を厳密に排除する設計を徹底しました。

## 2. 実施内容 (Implemented Actions)

### 2.1 血統適性特徴量の導入 (Phase A)
- **実装ファイル**: `src/preprocessing/bloodline_features.py`
- **概要**: 種牡馬 (Sire) および 母父 (BMS) の産駒成績を集計し、コース適性・距離適性・馬場適性を数値化。
- **技術的特徴**:
    - **Bayesian Smoothing (C=30, 50)**: 出走回数が少ない種牡馬のデータに補正をかけ、極端な値（1戦1勝で勝率100%など）を抑制。
    - **厳密なリーク防止**: 当該レース以前のデータのみを使用（`shift(1)` + `expanding`）。同日複数レース開催時のリークも排除。

### 2.2 騎手・調教師プロファイルの強化 (Phase B)
- **実装ファイル**: `src/preprocessing/profile_features.py`
- **概要**: 騎手と調教師の組み合わせ（ゴールデンコンビ）や、特定のコース条件における相性を数値化。
- **生成特徴量例**:
    - `jockey_course_win_rate`: 騎手×コースごとの勝率
    - `trainer_course_win_rate`: 調教師×コースごとの勝率
    - `jockey_trainer_win_rate`: 騎手×調教師のコンビ勝率

### 2.3 確定オッズリークの修正
- **問題**: T-10（発走10分前）オッズが存在しないデータにおいて、確定オッズが学習データに混入していた。
- **対策**: `step_inject_odds` を修正し、T-10データ欠損時はオッズ情報を `NaN` に置換することでリークを完全排除。（検証スクリプト `verify_odds_cleaning.py` にて動作確認済み）

### 2.4 スピード指数 (Phase C)
- **状況**: 設計完了 (`implementation_plan.md` 記載)。実装は次フェーズへ。

## 3. 検証結果 (Validation Results)

### 3.1 動作検証
- Docker環境上で検証スクリプト (`verify_bloodline_features.py`, `verify_profile_features.py`) を実行し、**計算ロジックの正当性とリークの不在**を確認しました。

### 3.2 2025年バックテスト結果
- **ROI**: **75.42%**
    - 前回検証時 (Phase 16時点): 79.74%
    - 結果: **-4.32% ポイントの低下**

## 4. 分析と考察 (Analysis)

バックテスト結果および Feature Importance の分析から、以下の課題が浮き彫りになりました。

1.  **過剰な「ID依存」による過学習**
    - Feature Importance の1位は `mare_id` (Gain: 175,429) であり、他の特徴量を圧倒しています。繁殖牝馬IDはカーディナリティ（種類数）が膨大であり、Trainデータへの過学習を引き起こしやすい特徴量です。これが汎化性能を下げている主因と推測されます。
    - `trainer_id`, `sire_id` なども上位にあり、今回追加した「集計特徴量（汎化された指標）」よりも「IDそのもの」が優先されています。

2.  **オッズリークの影響残存**
    - バックテストの全再計算がタイムアウトしたため、Feature Importance の2位に `odds` (確定オッズ) が残存しています。これがモデルの予測を歪めており、実運用環境（確定オッズなし）との乖離を生んでいます。

3.  **新特徴量の埋没**
    - 追加した `jockey_trainer_win_rate` は15位にランクインしましたが、ID特徴量の支配力が強すぎるため、十分な効果を発揮できていません。

## 5. 次フェーズへの提言 (Next Steps)

ROI 100%超えを目指すためには、単なる特徴量追加ではなく、モデル構造の抜本的な見直しが必要です。

1.  **ID特徴量の断捨離**: `mare_id` を削除、あるいは `sire_id` 等も削除し、「名前」ではなく「実績（集計値）」で予測させるモデルへ転換する。
2.  **モデルチューニング**: 特徴量増加に伴うパラメータ（正則化項など）の再調整。
3.  **Phase C の実装**: 絶対的な能力値である「スピード指数」を導入し、相手関係に依存しない強さを評価軸に加える。
