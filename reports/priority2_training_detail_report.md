# Priority 2: 調教詳細 (Training Detail) 実装報告書

## 1. 概要
Priority 2の実装目標であった「調教データの詳細化」と「対戦成績(Head-to-Head)」のうち、調教データの詳細化を完了しました。
対戦成績については計算コストの問題により実装を保留しましたが、調教データの改善のみでモデル性能（AUC）の向上を確認しました。

## 2. 実装内容

### (1) Loaderの拡張 (`src/preprocessing/loader.py`)
- **課題**: 従来は坂路調教データ（`jvd_hc`）のみを使用していたため、ウッドチップコースやポリトラックでの調教情報が欠落していました。
- **対応**: `jvd_wc`（コース調教）テーブルのロード処理を追加し、`jvd_hc`と統合しました。
  - 同日に坂路とコースの両方がある場合は坂路を優先（または最新を採用）するロジックを実装。
  - データ結合数が約38万件から約40万件へ増加しました。
- **補足修正**: PC-KEIBAスキーマにおける着差カラムの参照エラー（`res.chakusa` → `res.time_sa`）も修正しました。

### (2) 新規特徴量 (`src/preprocessing/features/training_detail.py`)
以下の3つの特徴量を追加しました。
1. **`training_course_cat`**: 調教コース種別（1:坂路, 2:ウッド, 3:ポリトラック, etc.）。
2. **`training_acceleration`**: ラスト1Fと全体平均ラップの差分を用いた簡易加速指標。
3. **`training_intensity_score`**: コース種別とタイム基準（4F/3F）を用いた強度スコア。

## 3. 評価結果

### モデル性能 (5-Fold CV)
Priority 1（ベースライン）と比較して、AUCが向上しました。

| モデル | 特徴量数 | Valid AUC | 向上幅 |
|:---|:---:|:---:|:---:|
| Priority 1 (Base) | 127 | 0.7519 | - |
| **Priority 2 (Training Detail)** | **130** | **0.7535** | **+0.0016** |

### 考察
新規追加した3つの特徴量自体はFeature ImportanceのTop 20には入りませんでしたが、Loaderの改善（`jvd_wc`統合）により、これまで調教データが欠落していた馬のデータが補完されました。これにより、既存の調教関連特徴量の信頼性が向上し、全体としての予測精度（AUC）の改善に繋がったと考えられます。

## 4. 未達事項と今後の課題 (Head-to-Head)
- **状況**: 全レース履歴を用いたペアワイズ対戦成績（Head-to-Head）の計算処理において、メモリ不足およびタイムアウトが発生しました。
- **原因**: 75万レース×平均14頭の全組み合わせ（約1000万ペア）に対する結合と集計処理が過負荷となりました。
- **対策**: 今回は実装を一時保留（Pending）としました。今後実装する場合は、計算対象を「直近3年」に限定する、あるいは年度ごとにループ処理してメモリを解放するなどの最適化が必要です。

## 5. 結論
Head-to-Headは未実装ですが、Training Detailの実装だけで**AUC 0.7535**を達成し、モデル性能を更新しました。
このモデルを新たな基準として採用可能です。
