# Phase 2: 前処理 & 特徴量エンジニアリング 開発ログ

## 方針
- DBから取得した生データを、LightGBM等のモデルが学習可能な形式（数値特徴量）に変換する。
- データの整合性を保ちながら、欠損値処理や異常値除去を行う。
- `Parquet` 形式を使用して中間データを高速に保存・読み込みする。

## 実装ステップ
1. **RawDataLoader:** 複数テーブルを結合してDataFrame化。
2. **DataCleanser:** クレンジング処理（欠損補完、型変換）。
3. **FeatureEngineer:** 基本特徴量（カテゴリ数値化、日付）の生成。
4. **HistoryAggregator:** 過去走特徴量の生成（実装済み）。
5. **CategoryAggregator:** 騎手等のカテゴリ別集計特徴量（実装済み）。
6. **DatasetSplitter:** 学習用データセットの分割と整形（実装済み）。

## 変更履歴
- **[2024-05-21]**: Phase 2 開始。`RawDataLoader` 実装完了。
- **[2024-05-21]**: Phase 1 の不備（年齢データ欠落）を修正。`parser.py`, `loader.py`, `00_init.sql` を更新し、`age` カラムを追加。
- **[2024-05-21]**: `DataCleanser` 実装完了。順位なしデータの削除、体重欠損の平均値補完など。
- **[2024-05-21]**: `FeatureEngineer` 実装完了。性別、天候、馬場状態の数値マッピング処理を追加。
- **[2024-05-21]**: パイプラインスクリプト `src/preprocessing/run_preprocessing.py` を作成。
- **[2024-05-21]**: `HistoryAggregator` 実装完了。`lag1` (前走) および `rolling_5` (近5走平均)、通算勝率などのラグ特徴量生成ロジックを追加。
- **[2024-05-21]**: `CategoryAggregator` 実装完了。騎手・調教師・種牡馬ごとの勝率・複勝率を時系列集計。
- **[2024-05-21]**: `DatasetSplitter` 実装完了。Train(2015-2022)/Valid(2023)/Test(2024)への分割と、未来情報の削除、LambdaRank用フォーマットへの変換。
- **[2024-05-21]**: **Phase 2 完了。** 全ての実装が統合され、前処理パイプラインが完成。

## 課題・メモ
- `margin` (着差) カラムがDBにないため、着差ベースの特徴量は未実装。
- データ量が増えた場合、`DatasetSplitter` でのメモリ消費が懸念される（Pickle保存）。必要に応じて分割保存を検討する。
