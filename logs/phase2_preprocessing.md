# Phase 2: 前処理 & 特徴量エンジニアリング 開発ログ

## 方針
- DBから取得した生データを、LightGBM等のモデルが学習可能な形式（数値特徴量）に変換する。
- データの整合性を保ちながら、欠損値処理や異常値除去を行う。
- `Parquet` 形式を使用して中間データを高速に保存・読み込みする。

## 実装ステップ
1. **RawDataLoader:** 複数テーブルを結合してDataFrame化。
2. **DataCleanser:** クレンジング処理（欠損補完、型変換）。
3. **FeatureEngineer:** 基本特徴量（カテゴリ数値化、日付）の生成。
4. **HistoryAggregator:** 過去走特徴量の生成（実装済み）。

## 変更履歴
- **[2024-05-21]**: Phase 2 開始。`RawDataLoader` 実装完了。
- **[2024-05-21]**: Phase 1 の不備（年齢データ欠落）を修正。`parser.py`, `loader.py`, `00_init.sql` を更新し、`age` カラムを追加。
- **[2024-05-21]**: `DataCleanser` 実装完了。順位なしデータの削除、体重欠損の平均値補完など。
- **[2024-05-21]**: `FeatureEngineer` 実装完了。性別、天候、馬場状態の数値マッピング処理を追加。
- **[2024-05-21]**: パイプラインスクリプト `src/preprocessing/run_preprocessing.py` を作成。
- **[2024-05-21]**: `HistoryAggregator` 実装完了。`lag1` (前走) および `rolling_5` (近5走平均)、通算勝率などのラグ特徴量生成ロジックを追加。

## 課題・メモ
- 馬の過去走（ラグ特徴量）の計算は計算コストが高いため、効率的な実装（Window関数やGroupByの活用）が必要。
- リークを防ぐため、集計特徴量は必ず「レース開催日より前のデータ」のみを使用すること。
- 現状 `margin` (着差) カラムがDBにないため、着差ベースの特徴量は未実装。必要に応じてPhase 1へ戻り `margin` を追加することを検討。
