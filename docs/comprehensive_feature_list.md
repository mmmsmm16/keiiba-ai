# 特徴量ギャップ分析と新規提案 (2026-01-20)

## 1. 概要
- **現状の特徴量数**: 294個 (加工済みカラム含む)
- **調査対象DB**: PC-KEIBA (JRA-VAN準拠, 全98テーブル)
- **目的**: データベースには存在するが、現在モデルに入力されていない「宝の山」を発掘し、具体的な特徴量化案を提示する。

---

## 2. 実装済みデータの確認
現在、以下のテーブル群は既にある程度活用されています。

- `jvd_se` (馬毎レース成績): 着順、タイム、上がり3F、コーナー順位など → **活用度: 高**
- `jvd_ra` (レース詳細): 距離、トラック、天候、馬場 → **活用度: 中** (詳細情報は未利用)
- `jvd_hc` / `jvd_wc` (調教): 本数、タイム → **活用度: 中**
- `jvd_bt` (系統): ※ごく一部の親系統のみ利用の可能性ありだが、詳細テキストは未利用。

---

## 3. 未利用データからの特徴量提案 (Gap Analysis)

### A. 【特大ポテンシャル】 系統情報・血統詳細 (`jvd_bt`)
現状、血統情報は `sire_id` (種牡馬ID) のターゲットエンコーディングなどの数値指標に留まっています。
`jvd_bt` には血統に関する**定性的な記述**が含まれており、これを活用しない手はありません。

| カラム名 | 説明 | 特徴量化案 | 期待される効果 |
| :--- | :--- | :--- | :--- |
| `keito_setsumei` | 系統説明 | **LLM Embedding**: 「仕上がり早」「ダート適性」「瞬発力」などの記述をベクトル化 (1536次元)。PCAで圧縮してモデルへ。 | 従来の数値データでは捉えきれない、血統ごとの**定性的な適性**（晩成、道悪巧者など）を学習可能にする。 |
| `keito_mei` | 系統名 | OneHot / Embedding | 「サンデーサイレンス系」などの大分類を明示的に入れる。 |

### B. 【大ポテンシャル】 レース展開・ラップ詳細 (`jvd_ra`)
レース全体の質を表すデータが不足しています。

| カラム名 | 説明 | 特徴量化案 | 期待される効果 |
| :--- | :--- | :--- | :--- |
| `lap_time` | ラップタイム (例: 12.2-10.8-...) | **ペース分解**:  (1) 前半3F - 後半3F (Pace Flow), (2) 最速ラップ地点, (3) ラップ分散 (淡々か急変か) | 逃げ・先行馬が「潰れる展開」か「残る展開」かを予測する上で決定的。過去走特徴量として、「タフなラップ経験」を数値化。 |
| `corner_tsuka_juni_1~4` | コーナー通過順位 | **位置取り変化率**: (4角順位 - 1角順位) / 頭数。まくり度合いを数値化。 | 展開のアヤ（まくってバテた、控えて届かず）をより解像度高く表現。 |

### C. 【中〜大ポテンシャル】 マイニング・予想誤差 (`jvd_se`)
JRA-VAN独自の予測値は、それ自体が強力なアンサンブル要素になります。

| カラム名 | 説明 | 特徴量化案 | 期待される効果 |
| :--- | :--- | :--- | :--- |
| `mining_kubun` | マイニング区分 | そのままカテゴリ特徴量 / ターゲットエンコーディング | JRA-VANが持つ独自非公開ロジックの推論結果をモデルに取り込む（スタッキング効果）。 |
| `yoso_soha_time` | 予想走破タイム | 実走タイムとの乖離 (`actual_time` - `yoso_time`) | 「予想以上に走った」馬を見つける指標。過小評価されている馬の発見。 |
| `yoso_gosa_plus/minus` | 予想誤差 | 同上 | |

### D. 【中ポテンシャル】 騎手・調教師のバックグラウンド (`jvd_ks`, `jvd_ch`)
騎手IDごとの集計値（勝率など）は入っていますが、個人の属性は入っていません。

| カラム名 | 説明 | 特徴量化案 | 期待される効果 |
| :--- | :--- | :--- | :--- |
| `seinengappi` | 生年月日 | **年齢**: レース当時の年齢。 | ベテランの経験値 vs 若手の勢い。減量騎手期間終了後の成績変化など。 |
| `tozai_shozoku_code` | 東西所属 | **輸送フラグ**: (馬の所属 x 騎手の所属 x 開催地) の組み合わせ。 | 「栗東騎手が中山で騎乗」などの本気度（勝負気配）を検知。 |
| `kishu_minarai_code` | 見習い区分 | カテゴリ変数 | 減量特典の有無を明示的に。 |

### E. 【中ポテンシャル】 馬場状態・気象条件の適正 (`jvd_se`, `jvd_wf`)
ご指摘の通り、現状は「距離適性」「コース適性」はあるものの、**「重馬場適性」** そのものは種牡馬データ (`sire_heavy_win_rate`) に頼っており、**その馬自身の重馬場実績** は特徴量化されていません。

| テーブル | カラム | 特徴量化案 | 期待される効果 |
| :--- | :--- | :--- | :--- |
| `jvd_se` | `going_code` | **馬場別勝率**: 良・稍重・重・不良ごとの勝率・複勝率。 | 「道悪の鬼」を種牡馬だけでなく、本人の実績から特定する。 |
| `jvd_wf` | `gan_suiritsu` | **含水率**: ダート戦において、含水率ごとの成績集計。 | 「パサパサのダート」と「脚抜きの良いダート」での適性差を捉える。 |
| `jvd_wf` | `cushion_chi` | **クッション値**: 芝レースでのクッション値ごとの成績。 | 硬い馬場が得意な馬、時計のかかる馬場が得意な馬の判別に有効。 |

### F. 【小〜中ポテンシャル】 その他
| テーブル | カラム | 案 |
| :--- | :--- | :--- |
| `jvd_jg` (除外) | - | 除外明けの馬フラグ（調整不足のリスク）。 |
| `jvd_ck` (着差コード) | `chakusa_code` | 「ハナ差」「大差」を数値だけでなくカテゴリとして。接戦強さを測る。 |

---

## 2. 優先度別実装フェーズ

### Refined Phase 1: Quick Wins (Availability: Easy, Impact: High)
- Target: 完了 (v12 Batch 1)
- **マイニング指数 (Mining Index)** (Implemented)
  - `jvd_se.mining_kubun`, `yoso_juni`, `yoso_soha_time`
  - 予測タイム差、予測着順差を作成。
- **馬場適性 (Track Aptitude)** (Implemented)
  - `going_code` (1:良, 2:稍重, 3:重, 4:不良) に基づく過去走集計。
  - `horse_going_win_rate`, `horse_going_top3_rate`, `is_proven_mudder` (重馬場適性)**効果**: 大
- **内容**: `jvd_ra.lap_time` をパースし、レースごとの「ハイペース/スローペース判定」を行い、各馬の「ハイペース経験」特徴量を作成。

### Phase 4.3: 系統情報のEmbedding化 (Unique / Innovative)
- **コスト**: 高 (LLM APIコスト + バッチ処理)
- **効果**: 特大 (他モデルとの差別化最大)
- **内容**: `jvd_bt.keito_setsumei` をEmbedding化し、PCAで圧縮して付与。

### Phase 4.4: 騎手年齢・所属情報の追加
- **コスト**: 低
- **効果**: 小〜中
- **内容**: マスタデータとの結合。

---

このリストを基に、まずは手軽かつ効果が見込める **Phase 4.1 (マイニング)** と **Phase 4.2 (ラップ解析)** から着手することを推奨します。
