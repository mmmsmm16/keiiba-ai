# JRAデータ全量調査と特徴量改善案 (2026-01-20)

## 概要
LambdaRankモデルの精度向上のため、現在データベース (PC-KEIBA Schema / PostgreSQL) に存在するが利用されていないデータを調査・整理しました。
本ドキュメントは、利用可能なデータソースの全容と、それに基づいた新規特徴量のアイデアをまとめたものです。

---

## 1. データソース概要

- **データベース**: PostgreSQL (`pckeiba` データベース)
- **スキーマ**: PC-KEIBA Database (JRA-VANデータ準拠)
- **データ形式**: 大半のカラムは `varchar` (文字列) で格納されており、数値としての利用にはキャストやパースが必要です。

### 主要テーブル一覧

| テーブル名 | 和名・説明 | 活用状況 | 潜在的価値 |
| :--- | :--- | :--- | :--- |
| **`jvd_ra`** | **レース詳細** | **一部利用** | **高** (詳細ラップ、コーナー別通過順など) |
| **`jvd_se`** | **馬毎成績** | **利用中** | **高** (マイニング、着差コード、相手馬情報) |
| **`jvd_bt`** | **系統情報** | **未使用** | **特大** (詳細な血統説明テキスト → Embeddings) |
| **`jvd_ks`** | **騎手マスタ** | **未使用** | **中** (生年月日、初勝利情報) |
| **`jvd_ch`** | **調教師マスタ** | **未使用** | **中** (所属、生年月日) |
| **`jvd_hc`** | **坂路調教** | **利用中** | **中** (ラップタイム詳細) |
| **`jvd_wc`** | **コース調教** | **利用中** | **中** |
| `jvd_hy` | 馬名由来 | 未使用 | 低 (テキスト特徴量？) |

---

## 2. 詳細データ定義と活用アイデア

### A. `jvd_ra` (レース詳細)
現在、基本的なコース条件（距離、馬場）は使われていますが、レース展開に関する詳細情報が眠っています。

| カラム名 | 説明 | データ例 | 特徴量アイデア |
| :--- | :--- | :--- | :--- |
| `lap_time` | ラップタイム | `"122-108-115..."` | **ペース分解**: 前半/中盤/後半のラップ構成から、そのレースが「消耗戦」だったか「瞬発力勝負」だったかを数値化。過去走データの質を高める。 |
| `corner_tsuka_juni_1~4` | コーナー通過順位 | `"05-05-04"` | **展開マップ**: 各コーナーでの位置取りの変化をトラック。まくり気味に上がったのか、垂れたのかを詳細に把握。 |
| `shusso_tosu` | 出走頭数 | `16` | **頭数補正**: 多頭数/少頭数での成績バイアスを補正するための明示的特徴量。 |
| `honshokin`, `fukashokin` | 賞金明細 | - | レースレベルのより詳細な指標として。 |

### B. `jvd_se` (馬毎成績)
結果データですが、学習時の「目的変数」だけでなく、過去走の特徴量としても重要です。

| カラム名 | 説明 | 特徴量アイデア |
| :--- | :--- | :--- |
| `mining_kubun` | マイニング区分 | **外部予測値**: JRA-VAN独自のマイニング予想。モデルのアンサンブル要素として強力な可能性。 |
| `yoso_soha_time` | 予想走破タイム | 同上。 |
| `chakusa_code_1~3` | 着差コード | 単純な秒差だけでなく、「大差」「ハナ」などの定性的な勝ち負け情報をカテゴリ特徴量化。 |
| `aiteuma_joho_1~3` | 相手馬情報 | 接戦だった相手の名前/ID。強い相手と接戦した実績を評価するグラフ特徴量など。 |
| `kyakushitsu_hantei` | 脚質判定 | JRA-VAN公式の脚質判定（逃げ、先行...）。自作ロジックとの比較や補完。 |

### C. `jvd_bt` (系統情報) - 最重要ターゲット
これまで全く未着手の領域です。

| カラム名 | 説明 | データ例 | 特徴量アイデア |
| :--- | :--- | :--- | :--- |
| `keito_mei` | 系統名 | `"サンデーサイレンス系"` | カテゴリ特徴量としての利用。 |
| `keito_setsumei` | **系統説明** | (長文テキスト) | **LLM Embeddings**: 血統の特徴（早熟、スタミナ型、ダート適性など）が文章で記述されている。これを`text-embedding-3-small`などでベクトル化し、血統特徴量としてモデルに入力する。 |

### D. `jvd_ks` / `jvd_ch` (騎手・調教師)
プロフィールの静的データが主です。

| カラム名 | 説明 | 特徴量アイデア |
| :--- | :--- | :--- |
| `seinengappi` | 生年月日 | **騎手年齢**: ベテラン/若手の区分。反射神経の衰えや経験値のプロキシ。 |
| `menkyo_kofu_nengappi` | 免許交付日 | **キャリア年数**: 騎手・調教師の経験年数。 |
| `tozai_shozoku_code` | 東西所属 | 輸送の有無（関東馬が関西のレースに出る場合など）と組み合わせて、「アウェーでの強さ」を測る。 |

---

## 3. 実装に向けたステップ (Phase 4 提案)

### Step 1: `jvd_bt` (系統説明) のEmbedding化
1.  DBから `jvd_bt` を全件ダンプする。
2.  OpenAI API等を用いて `keito_setsumei` をベクトル化する (例: 1536次元)。
3.  `horse_id` -> `sire_id` -> `jvd_bt` の結合を行い、各馬に「父系統ベクトル」「母父系統ベクトル」を付与する。

### Step 2: ラップタイム解析 (`jvd_ra`)
1.  `lap_time` 文字列をパースし、レースごとの「テン3F」「中盤平均」「上がり3F」を算出する。
2.  各レースを「Sペース」「Mペース」「Hペース」に分類し、過去走特徴量に「Hペースでの好走経験あり」のようなフラグを追加する。

### Step 3: マイニング指数の導入
1.  `mining_kubun` 等をロード対象に追加。
2.  単純な特徴量としてLightGBMに追加し、重要度を確認する。

### Step 4: 騎手/調教師プロフィールの結合
1.  `jvd_ks`, `jvd_ch` をロード。
2.  年齢、所属を計算してマージ。

---

この資料に基づき、優先度をつけて順次実装していくことを推奨します。
特に **Step 1 (系統Embedding)** は、LambdaRankのような非線形モデルと相性が良く、従来のカテゴリ変数では捉えきれなかった血統のニュアンスを学習できるため、最大の改善幅が見込めます。
