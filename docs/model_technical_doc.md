# v13 予測モデル 技術解説

**バージョン**: v13_market_residual
**作成日**: 2025-12-16
**特徴量数**: 192

---

## 1. モデル概要

### 1.1 アーキテクチャ

```
┌─────────────────────────────────────────────────────────────────────┐
│ v13 Market Residual Model                                            │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  入力特徴量 (192個)                                                  │
│      ↓                                                              │
│  LightGBM アンサンブル (Walk-Forward 3-Fold)                        │
│      ↓                                                              │
│  Raw Logit スコア                                                   │
│      ↓                                                              │
│  Sigmoid → Raw確率                                                  │
│      ↓                                                              │
│  Softmax (レース内正規化) → 各馬の勝率                              │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 1.2 核心アイデア: Market Residual

**従来のアプローチ**:
- モデルが「ゼロから」勝率を予測

**v13 Market Residual**:
- **市場確率（オッズ由来）をベースライン**として使用
- モデルは「市場からの乖離」を学習
- 最終予測 = 市場が見逃した情報を反映

```
p_market = 1 / odds  (オッズから計算した市場確率)
baseline_logit = logit(p_market)

モデル出力 = baseline_logit + delta_logit
                           ↑
                   モデルが学習する部分
                   (市場が織り込んでいない情報)
```

---

## 2. 入力特徴量 (192個)

### 2.1 カテゴリ別内訳

| カテゴリ | 特徴量数 | 説明 |
|----------|----------|------|
| **レース基本情報** | 15 | 距離、馬場、天気など |
| **馬基本情報** | 8 | 馬番、年齢、性別、斤量など |
| **過去成績 (Lag)** | 25 | 直近1-5走の着順、タイムなど |
| **騎手集計** | 20 | 騎手別勝率、複勝率など |
| **調教師集計** | 20 | 調教師別勝率など |
| **血統集計** | 16 | 種牡馬・母父別勝率など |
| **コース経験** | 15 | コース・距離経験値など |
| **市場情報** | 5 | オッズ、人気、baseline_logit |
| **高度特徴量** | 30+ | 展開予測、相対評価など |
| **その他** | 38 | 欠損フラグ、埋め込みなど |

### 2.2 レース基本情報

| 特徴量名 | 説明 | 例 |
|----------|------|-----|
| `race_number` | レース番号 | 1-12 |
| `distance` | 距離(m) | 1200, 1600, 2000 |
| `surface_num` | 馬場 | 1=芝, 2=ダート |
| `state_num` | 馬場状態 | 1=良, 2=稍重, 3=重, 4=不良 |
| `weather_num` | 天気 | 1=晴, 2=曇, 3=雨 |
| `month` | 月 | 1-12 |
| `weekday` | 曜日 | 0=月, 6=日 |

### 2.3 馬基本情報

| 特徴量名 | 説明 | 例 |
|----------|------|-----|
| `horse_number` | 馬番 | 1-18 |
| `frame_number` | 枠番 | 1-8 |
| `age` | 年齢 | 2-10 |
| `sex_num` | 性別 | 1=牡, 2=牝, 3=セン |
| `weight` | 馬体重(kg) | 400-550 |
| `weight_diff` | 馬体重増減 | -10 ~ +10 |
| `impost` | 斤量(kg) | 51-58 |

### 2.4 過去成績 (最重要)

| 特徴量名 | 説明 | データリーク防止 |
|----------|------|-----------------|
| `lag1_rank` | 前走着順 | shift(1)適用 ✅ |
| `lag1_last_3f` | 前走上がり3F | shift(1)適用 ✅ |
| `lag1_odds` | 前走オッズ | shift(1)適用 ✅ |
| `mean_rank_5` | 直近5走平均着順 | expanding適用 ✅ |
| `mean_last_3f_5` | 直近5走平均上がり | expanding適用 ✅ |
| `total_races` | 通算出走数 | 当該レース除外 ✅ |

**重要**: すべて shift(1) または expanding() で、**当該レースの結果は含まない**

### 2.5 騎手・調教師集計

| 特徴量名 | 説明 |
|----------|------|
| `jockey_win_rate` | 騎手の通算勝率 |
| `jockey_top3_rate` | 騎手の複勝率 |
| `jockey_n_races` | 騎手の出走回数 |
| `jockey_distance_win_rate` | 騎手×距離別勝率 |
| `trainer_win_rate` | 調教師の通算勝率 |
| `trainer_top3_rate` | 調教師の複勝率 |

### 2.6 血統集計

| 特徴量名 | 説明 |
|----------|------|
| `sire_win_rate` | 種牡馬産駒の勝率 |
| `sire_top3_rate` | 種牡馬産駒の複勝率 |
| `sire_n_races` | 種牡馬産駒の出走数 |
| `bms_win_rate` | 母父産駒の勝率 |
| `bms_top3_rate` | 母父産駒の複勝率 |

### 2.7 コース・距離経験

| 特徴量名 | 説明 |
|----------|------|
| `course_experience` | このコースでの過去走数 |
| `course_best_rank` | このコースでの最高着順 |
| `distance_experience` | この距離帯での過去走数 |
| `first_turf` | 初芝フラグ (0/1) |
| `first_dirt` | 初ダートフラグ (0/1) |
| `jockey_change` | 騎手乗り替わりフラグ |

### 2.8 市場情報 (Market Data)

| 特徴量名 | 説明 | 重要度 |
|----------|------|--------|
| `baseline_logit` | logit(1/odds) | ⭐⭐⭐⭐⭐ |
| `popularity` | 人気順 | ⭐⭐⭐ |
| `odds` | 単勝オッズ（除外済み） | - |
| `p_market` | 市場確率（除外済み） | - |

**`baseline_logit`** が最も重要な特徴量。市場の集合知をベースラインとして活用。

---

## 3. 学習プロセス

### 3.1 Walk-Forward Cross-Validation

```
訓練データ      検証データ
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
2021          → 2022 を評価
2021-2022     → 2023 を評価
2021-2023     → 2024 を評価
2021-2024     → 2025 に推論
```

**利点**: 
- 未来データで学習しない（時間的リーク防止）
- 複数の時期で評価可能

### 3.2 LightGBM パラメータ

```python
LGBM_PARAMS = {
    'objective': 'binary',
    'metric': 'binary_logloss',
    'learning_rate': 0.05,
    'num_leaves': 31,
    'max_depth': -1,
    'min_data_in_leaf': 50,
    'feature_fraction': 0.8,
    'bagging_fraction': 0.8,
    'bagging_freq': 5
}
```

### 3.3 ターゲット変数

```python
target = (rank == 1).astype(int)  # 1着なら1、それ以外は0
```

---

## 4. 推論プロセス

### 4.1 ステップバイステップ

```
1. DBからレースデータ取得
   - 出走馬情報、オッズ、直近成績
   ↓

2. 特徴量生成 (InferencePreprocessor)
   - 192特徴量を計算
   - 過去データと結合して集計特徴量を更新
   ↓

3. モデル推論 (3モデルアンサンブル)
   - 各Foldモデルで予測
   - 平均を取得
   ↓

4. Sigmoid変換
   raw_prob = sigmoid(model_output)
   ↓

5. Softmax正規化 (レース内)
   prob_i = exp(raw_prob_i) / Σ exp(raw_prob_j)
   
   → 各馬の確率が合計100%になる
```

### 4.2 コード例

```python
# アンサンブル予測
preds = []
for model in models:
    pred = model.predict(X)
    preds.append(pred)

avg_pred = np.mean(preds, axis=0)  # 平均

# Sigmoid
prob_raw = 1 / (1 + np.exp(-avg_pred))

# Softmax per race
exp_vals = np.exp(prob_raw - prob_raw.max())  # 数値安定化
prob = exp_vals / exp_vals.sum()
```

---

## 5. 確率の解釈

### 5.1 出力例

```
レース: 中山11R (12頭立て)

馬番  馬名              確率
━━━━━━━━━━━━━━━━━━━━━━━━━
  5  ダイヤモンド     18.2%  ← 最も高い勝率
  3  ステイゴールド   15.6%
  8  シルヴァーソニック 13.4%
 12  テーオーロイヤル   9.8%
  1  マイネルファンロン  8.5%
  ...
━━━━━━━━━━━━━━━━━━━━━━━━━
合計:                100.0%  ← 常に100%
```

### 5.2 確率の意味

| 確率 | 解釈 |
|------|------|
| 20%+ | 本命馬、高い勝利期待 |
| 10-20% | 対抗馬、上位候補 |
| 5-10% | 穴馬、ワンチャンあり |
| 5%未満 | 厳しい、よほどの展開待ち |

### 5.3 市場との比較

```
モデル確率 > 市場確率 → 「市場が過小評価」 → 期待値プラス
モデル確率 < 市場確率 → 「市場が過大評価」 → 期待値マイナス
```

---

## 6. モデルの強み・弱み

### 6.1 強み

| 項目 | 説明 |
|------|------|
| **市場情報活用** | オッズをベースラインに使用 |
| **豊富な特徴量** | 192特徴量で多角的評価 |
| **リーク防止** | Walk-Forward + shift(1)で未来情報を排除 |
| **アンサンブル** | 3モデル平均で安定性向上 |

### 6.2 弱み・注意点

| 項目 | 説明 |
|------|------|
| **オッズ依存** | 確定オッズ前提、事前オッズとの乖離 |
| **新馬戦** | 過去成績がないため予測精度低下 |
| **長期休養明け** | 直近データが古い場合精度低下 |
| **極端なオッズ** | 超人気薄/超本命は予測ブレやすい |

---

## 7. 補足: 確率計算の数式

### Softmax 正規化

レース内の馬 $i$ の最終確率:

$$P_i = \frac{e^{s_i}}{\sum_{j=1}^{N} e^{s_j}}$$

ここで:
- $s_i$ = モデルの raw スコア
- $N$ = 出走頭数

### 期待値 (EV) 計算

$$EV = P_i \times Odds_i - 1$$

- EV > 0: 期待値プラス（購入推奨）
- EV < 0: 期待値マイナス

---

## 8. 参照ファイル

| ファイル | 内容 |
|----------|------|
| `src/phase6/train_market_residual_wf.py` | モデル学習 |
| `src/phase6/infer_v13_2025.py` | 推論スクリプト |
| `models/v13_market_residual/` | 学習済みモデル |
| `src/preprocessing/` | 特徴量生成 |
