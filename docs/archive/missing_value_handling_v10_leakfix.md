# ç«¶é¦¬AI: æ¬ æå€¤ãƒ»ç•°å¸¸å€¤å‡¦ç†ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ (v10_leakfix)

## æ¦‚è¦

**ç·ã‚«ãƒ©ãƒ æ•°**: 203åˆ—  
**æ¬ æãŒã‚ã‚‹ã‚«ãƒ©ãƒ **: 15åˆ— (7.4%)  
**æ¬ æãªã—ã‚«ãƒ©ãƒ **: 188åˆ— (92.6%)

---

## 1. æ¬ æå€¤å‡¦ç†æ–¹é‡

### åŸºæœ¬æ–¹é‡

1. **åˆå‡ºèµ°é¦¬**: lag/rollingç‰¹å¾´ã¯è‡ªç„¶ã¨NaNã«ãªã‚‹ â†’ **0 or ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã§åŸ‹ã‚ã‚‹**
2. **ãƒ‡ãƒ¼ã‚¿æ¬ è½**: mare_id/bms_idãªã© â†’ **'unknown'ã¾ãŸã¯0ã§åŸ‹ã‚ã‚‹**
3. **è¨ˆç®—ä¸èƒ½**: æ¨™æº–åŒ–ãƒ»ç›¸å¯¾åŒ–ç‰¹å¾´(å˜é ­ãƒ¬ãƒ¼ã‚¹ç­‰) â†’ **0ã§åŸ‹ã‚ã‚‹**
4. **ãƒªãƒ¼ã‚¯é˜²æ­¢**: æœªæ¥æƒ…å ±ã¯ä½¿ã‚ãšã€éå»å¹³å‡ã‚„å®‰å…¨ãªå€¤ã§è£œå®Œ

---

## 2. ã‚«ãƒ©ãƒ åˆ¥æ¬ æå€¤ãƒ»ç•°å¸¸å€¤å‡¦ç†è©³ç´°

### ğŸ”´ æ¬ æç‡ãŒé«˜ã„ã‚«ãƒ©ãƒ  (>8%)

#### 1-2. `mean_rank_5` / `mean_last_3f_5` (35.6%)
- **æ¬ æç†ç”±**: 5èµ°ä»¥ä¸Šã®å±¥æ­´ãŒãªã„é¦¬(æ–°é¦¬ãƒ»è‹¥é¦¬)
- **å‡¦ç†æ–¹æ³•**: **NaN â†’ 0** (è‡ªå‹•çš„ã«fillna(0)ã§åŸ‹ã‚ã‚‹)
- **ç•°å¸¸å€¤**: ãªã—
- **ã‚³ãƒ¼ãƒ‰**: 
```python
df['mean_rank_5'] = grouped['rank'].transform(
    lambda x: x.shift(1).rolling(5).mean()
)
# NaNã¯å¾Œå‡¦ç†ã§0åŸ‹ã‚
```

#### 3-4. `mare_id` / `bms_id` (16.2%)
- **æ¬ æç†ç”±**: æ¯é¦¬ãƒ»æ¯çˆ¶æƒ…å ±ãŒæ¬ è½
- **å‡¦ç†æ–¹æ³•**: **NaN â†’ 'unknown'** (è¡€çµ±ç‰¹å¾´é‡è¨ˆç®—ã§åˆ¥æ‰±ã„)
- **ç•°å¸¸å€¤**: ãªã—
- **ã‚³ãƒ¼ãƒ‰**:
```python
# è¡€çµ±ãƒãƒƒãƒ”ãƒ³ã‚°æ™‚ã«æ¬ æã¯'unknown'ã¨ã—ã¦æ‰±ã†
if self.bloodline_map.empty:
    logger.warning("è¡€çµ±æƒ…å ±ãŒç©ºã®ãŸã‚ã€ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚")
```

#### 5-10. Lag1ç‰¹å¾´ (8.6%)
ã‚«ãƒ©ãƒ : `lag1_rank`, `lag1_last_3f`, `lag1_odds`, `lag1_popularity`, `mean_rank_all`, `wins_all`
- **æ¬ æç†ç”±**: åˆå‡ºèµ°ã®é¦¬
- **å‡¦ç†æ–¹æ³•**: 
  - `lag1_rank`: **NaN â†’ 10** (ä¸­ä½æƒ³å®š)
  - `lag1_odds`: **NaN â†’ å¹³å‡ã‚ªãƒƒã‚º**
  - `mean_rank_all`: **NaN â†’ 0**
  - `wins_all`: **NaN â†’ 0**
- **ç•°å¸¸å€¤**: ãªã—
- **ã‚³ãƒ¼ãƒ‰**:
```python
df['lag1_rank'] = grouped['rank'].shift(1)  # NaNã¯å¾Œå‡¦ç†
df['mean_rank_all'] = grouped['rank'].transform(
    lambda x: x.shift(1).expanding().mean()
)
# è¨ˆç®—å¾Œã«fillna()ã§è£œå®Œ
```

#### 11-15. ç›¸å¯¾åŒ–ç‰¹å¾´ (0.02%)
ã‚«ãƒ©ãƒ : `*_deviation`, `age_deviation`
- **æ¬ æç†ç”±**: ãƒ¬ãƒ¼ã‚¹å†…ã«1é ­ã—ã‹ã„ãªã„å ´åˆ(æ¨™æº–åå·®=0)
- **å‡¦ç†æ–¹æ³•**: **NaN â†’ 0** (æ¨™æº–åŒ–ã§ããªã„å ´åˆã¯å¹³å‡ã¨è¦‹ãªã™)
- **ç•°å¸¸å€¤**: ãªã—
- **ã‚³ãƒ¼ãƒ‰**:
```python
df['jockey_id_win_rate_deviation'] = (
    df['jockey_id_win_rate'] - race_mean
) / (race_std + 1e-8)  # ã‚¼ãƒ­é™¤ç®—é˜²æ­¢
df.fillna(0, inplace=True)
```

---

### âšª æ¬ æ

ãªã—ã®ã‚«ãƒ©ãƒ  (188åˆ—)

ã“ã‚Œã‚‰ã®ã‚«ãƒ©ãƒ ã¯æ¬ æå€¤ãŒãªã„ã‹ã€å‰å‡¦ç†ã§å®Œå…¨ã«è£œå®Œæ¸ˆã¿ã§ã™ã€‚

#### åŸºæœ¬ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ (17åˆ—)
å…¨ã¦æ¬ æãªã—ã€‚ç”Ÿãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ç›´æ¥å–å¾—ã¾ãŸã¯æ•°å€¤åŒ–æ¸ˆã¿ã€‚

#### éå»èµ°ç‰¹å¾´ (é™¤ãLag1) (7åˆ—)
- `total_races`: cumcount()ã§è¨ˆç®— â†’ æ¬ æãªã—
- `win_rate_all`: 0é™¤ç®—é˜²æ­¢ã§ `.fillna(0)`
- `total_prize`: `.fillna(0)`

#### ã‚«ãƒ†ã‚´ãƒªçµ±è¨ˆ (45åˆ—)
å…¨ã¦ãƒªãƒ¼ã‚¯å¯¾ç­–å¾Œã« `.fillna(0)` ã§è£œå®Œã€‚

**ã‚³ãƒ¼ãƒ‰ä¾‹**:
```python
df[f'{col}_n_races'] = df['cum_races'].fillna(0)
df[f'{col}_win_rate'] = df['cum_wins'].fillna(0) / (
    df['cum_races'].fillna(0) + 1e-5
)
```

#### è¡€çµ±ç‰¹å¾´ (8åˆ—)
`sire_*`, `bms_*` ã¯ `.fillna(0)` ã§è£œå®Œã€‚

**ã‚³ãƒ¼ãƒ‰**:
```python
cols_to_fill = [
    c for c in df.columns 
    if (c.startswith('sire_') or c.startswith('bms_')) 
    and not c.endswith('_id')
]
df[cols_to_fill] = df[cols_to_fill].fillna(0)
```

#### å±•é–‹ãƒ»ãƒšãƒ¼ã‚¹ç‰¹å¾´ (11åˆ—)
- `interval`: åˆå‡ºèµ°ã®å ´åˆ `.fillna(0)`
- `nige_rate`: `.fillna(0)`
- `race_*`: ãƒ¬ãƒ¼ã‚¹é›†è¨ˆã§ `.fillna(0)`

#### ä¸åˆ©æ¤œå‡ºç‰¹å¾´ (5åˆ—)
å…¨ã¦ `.fillna(0)` ã§è£œå®Œã€‚

**ã‚³ãƒ¼ãƒ‰**:
```python
df['prev_disadvantage_score'] = df.groupby('horse_id')[
    'temp_disadv_sum'
].shift(1).fillna(0)
```

#### ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç‰¹å¾´ (5åˆ—)
ç¬¬1ãƒ¬ãƒ¼ã‚¹ã¯å‰ãƒ¬ãƒ¼ã‚¹ãŒãªã„ãŸã‚ã€**å¹³å‡çš„ãªå€¤**ã§åŸ‹ã‚ã‚‹ã€‚

**ã‚³ãƒ¼ãƒ‰**:
```python
defaults = {
    'trend_win_inner_rate': 0.25,
    'trend_win_mid_rate': 0.50,
    'trend_win_outer_rate': 0.25,
    'trend_win_front_rate': 0.20,
    'trend_win_fav_rate': 0.33
}
for col, val in defaults.items():
    df_out[col] = df_out[col].fillna(val)
```

#### åŸ‹ã‚è¾¼ã¿ç‰¹å¾´ (32åˆ—)
Embeddingå±¤ã§ç”Ÿæˆã€‚æ¬ æãªã—(0ãƒ™ã‚¯ãƒˆãƒ«ã§åˆæœŸåŒ–)ã€‚

#### çµŒé¨“å€¤ç‰¹å¾´ (9åˆ—)
- `course_best_rank`, `distance_best_rank`: åˆæŒ‘æˆ¦ã®å ´åˆ `.fillna(99)`
- ãƒ•ãƒ©ã‚°ç³»(`first_*`): æ¬ æãªã—(0 or 1)

**ã‚³ãƒ¼ãƒ‰**:
```python
df['course_best_rank'] = grouped['rank'].transform(
    lambda x: x.shift(1).expanding().min()
).fillna(99).astype('float32')
```

#### ãƒ¬ãƒ¼ã‚¹ãƒ¬ãƒ™ãƒ«ç‰¹å¾´ (2åˆ—)
- `race_member_strength`: `.fillna(8.0)` (å¹³å‡ç€é †=8æƒ³å®š)
- `relative_strength`: `.fillna(0)`

---

## 3. ç•°å¸¸å€¤å‡¦ç†

### ğŸ” æ¤œå‡ºã•ã‚ŒãŸç•°å¸¸å€¤ãƒ‘ã‚¿ãƒ¼ãƒ³

#### 1. `odds` (0.0 ~ 999.9)
- **ç•°å¸¸å€¤**: odds=0.0, odds=999.9
- **å¯¾å‡¦**: 
  - 0.0 â†’ å˜å‹ã‚ªãƒƒã‚ºæœªè¨­å®š(æ¨å®š1.0ã«è£œæ­£)
  - 999.9 â†’ è¶…é«˜ã‚ªãƒƒã‚º(ãã®ã¾ã¾ä½¿ç”¨ã€logå¤‰æ›ã§å¹³æ»‘åŒ–)
- **ã‚³ãƒ¼ãƒ‰**:
```python
odds = df['odds'].fillna(1.0)  # æœªè¨­å®šã¯1.0
```

#### 2. `weight` (0.0 ~ 999.0)
- **ç•°å¸¸å€¤**: weight=0, weight=999
- **å¯¾å‡¦**: å¹³å‡ä½“é‡(464kg)ã§è£œå®Œ
- **ã‚³ãƒ¼ãƒ‰**:
```python
if df['weight'].isnull().any():
    mean_weight = df['weight'].mean()
    df['weight'] = df['weight'].fillna(mean_weight)
```

#### 3. `weight_diff` (-98 ~ 999)
- **ç•°å¸¸å€¤**: -98kg, +999kg
- **å¯¾å‡¦**: åˆå‡ºèµ°ã¾ãŸã¯è¨ˆæ¸¬ä¸èƒ½ â†’ 0ã«è£œæ­£
- **ã‚³ãƒ¼ãƒ‰**:
```python
df['weight_diff'] = df['weight_diff'].fillna(0)
```

#### 4. `rank` (0 ~ 24)
- **ç•°å¸¸å€¤**: rank=0
- **å¯¾å‡¦**: ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒ¬ãƒ³ã‚¸ãƒ³ã‚°æ®µéšã§å‰Šé™¤
- **ã‚³ãƒ¼ãƒ‰**:
```python
# é †ä½ãŒãªã„ãƒ‡ãƒ¼ã‚¿(å–æ¶ˆãƒ»ä¸­æ­¢)ã‚’å‰Šé™¤
df = df.dropna(subset=['rank'])
df['rank'] = df['rank'].astype(int)
```

#### 5. `total_prize` (å…¨ã¦0)
- **çŠ¶æ³**: è³é‡‘ãƒ‡ãƒ¼ã‚¿ãŒåˆ¥ãƒ†ãƒ¼ãƒ–ãƒ«ã«ã‚ã‚‹å¯èƒ½æ€§
- **å¯¾å‡¦**: ç¾çŠ¶ã¯0ã®ã¾ã¾(ç‰¹å¾´é‡ã¨ã—ã¦æ©Ÿèƒ½ã—ã¦ã„ãªã„å¯èƒ½æ€§)
- **æ”¹å–„æ¡ˆ**: `honshokin`ã‚«ãƒ©ãƒ ã¨çµ±åˆ

---

## 4. æ¬ æå€¤è£œå®Œã®å„ªå…ˆé †ä½

### Level 1: ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒ¬ãƒ³ã‚¸ãƒ³ã‚° (cleansing.py)
1. `rank`ãŒæ¬ æ â†’ **å‰Šé™¤** (å–æ¶ˆãƒ»ä¸­æ­¢ãƒ¬ãƒ¼ã‚¹)
2. `weight` â†’ **å¹³å‡å€¤ã§åŸ‹ã‚ã‚‹**
3. `weight_diff` â†’ **0ã§åŸ‹ã‚ã‚‹**

### Level 2: ç‰¹å¾´é‡ç”Ÿæˆæ™‚ (feature_engineering.py, aggregators.py)
1. ã‚«ãƒ†ã‚´ãƒªãƒãƒƒãƒ—æœªå®šç¾© â†’ **0 or 'unknown'**
2. åˆå‡ºèµ°(lag/rolling) â†’ **0ã¾ãŸã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤**
3. è¨ˆç®—ä¸èƒ½(0é™¤ç®—ç­‰) â†’ **0**

### Level 3: é«˜åº¦ç‰¹å¾´é‡ç”Ÿæˆæ™‚ (advanced_features.pyç­‰)
1. ç›¸å¯¾åŒ–ç‰¹å¾´(æ¨™æº–åå·®=0) â†’ **0**
2. expandingçµ±è¨ˆ(åˆå›) â†’ **0ã¾ãŸã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤**

---

## 5. ãƒ‡ãƒ¼ã‚¿å“è³ªãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### âœ… å®Ÿè£…æ¸ˆã¿
- [x] NULLå€¤ã®è­˜åˆ¥ã¨è£œå®Œ
- [x] ç•°å¸¸å€¤ã®æ¤œå‡º(min/maxç¯„å›²å¤–)
- [x] æ™‚ç³»åˆ—ãƒªãƒ¼ã‚¯é˜²æ­¢(shift/expanding)
- [x] ã‚¼ãƒ­é™¤ç®—é˜²æ­¢(+1e-5, +1e-8)
- [x] å‹å¤‰æ›ã¨ãƒ€ã‚¦ãƒ³ã‚­ãƒ£ã‚¹ãƒˆ(float32)

### ğŸ”§ æ”¹å–„ä½™åœ°ã‚ã‚Š
- [ ] `total_prize`ãŒå…¨ã¦0 â†’ `honshokin`ã¨ã®çµ±åˆ
- [ ] `odds=999.9`ã®æ‰±ã„ â†’ ã‚­ãƒ£ãƒƒãƒ—å‡¦ç†æ¤œè¨
- [ ] `weight=0`ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ â†’ ã‚ˆã‚Šé©åˆ‡ãªè£œå®Œæ–¹æ³•

---

## 6. ã‚³ãƒ¼ãƒ‰ä¾‹: çµ±åˆçš„ãªæ¬ æå€¤å‡¦ç†

```python
def handle_missing_values(df: pd.DataFrame) -> pd.DataFrame:
    """
    å…¨ç‰¹å¾´é‡ã®æ¬ æå€¤ã‚’çµ±ä¸€çš„ã«å‡¦ç†
    """
    # 1. åŸºæœ¬è£œå®Œ
    fill_zero = [
        'mean_rank_5', 'mean_last_3f_5', 'lag1_rank',
        'mean_rank_all', 'wins_all', 'win_rate_all',
        'interval', 'nige_rate', 'prev_disadvantage_score'
    ]
    for col in fill_zero:
        if col in df.columns:
            df[col] = df[col].fillna(0)
    
    # 2. ã‚«ãƒ†ã‚´ãƒªIDç³»
    id_cols = ['mare_id', 'bms_id'ã€ 'jockey_id', 'trainer_id']
    for col in id_cols:
        if col in df.columns:
            df[col] = df[col].fillna('unknown')
    
    # 3. çµŒé¨“å€¤ç³»(æœªçµŒé¨“=99)
    best_rank_cols = ['course_best_rank', 'distance_best_rank']
    for col in best_rank_cols:
        if col in df.columns:
            df[col] = df[col].fillna(99)
    
    # 4. ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç‰¹å¾´(ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤)
    df['trend_win_inner_rate'] = df['trend_win_inner_rate'].fillna(0.25)
    df['trend_win_mid_rate'] = df['trend_win_mid_rate'].fillna(0.50)
    df['trend_win_outer_rate'] = df['trend_win_outer_rate'].fillna(0.25)
    
    return df
```

---

## 7. ã¾ã¨ã‚

### æ¬ æå€¤åˆ†å¸ƒ

| æ¬ æç‡ | ã‚«ãƒ©ãƒ æ•° | ä¸»ãªåŸå›  |
|--------|---------|---------|
| 0% | 188åˆ— | è£œå®Œæ¸ˆã¿ã¾ãŸã¯æ¬ æãªã— |
| 0-1% | 5åˆ— | ç›¸å¯¾åŒ–ç‰¹å¾´(å˜é ­ãƒ¬ãƒ¼ã‚¹) |
| 8-9% | 5åˆ— | åˆå‡ºèµ°é¦¬(lagç‰¹å¾´) |
| 16% | 2åˆ— | è¡€çµ±æƒ…å ±æ¬ è½ |
| 35% | 2åˆ— | è‹¥é¦¬(5èµ°æœªæº€) |

### å‡¦ç†æˆ¦ç•¥

1. **å‰Šé™¤**: `rank`ãŒæ¬ æ(å–æ¶ˆãƒ»ä¸­æ­¢)
2. **0åŸ‹ã‚**: éå»èµ°çµ±è¨ˆã€é›†è¨ˆç‰¹å¾´
3. **ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤**: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç‰¹å¾´ã€çµŒé¨“å€¤
4. **å¹³å‡å€¤**: ä½“é‡ãªã©ã®ç‰©ç†é‡
5. **'unknown'**: ã‚«ãƒ†ã‚´ãƒªID

**å…¨ç‰¹å¾´é‡ã¯æ¨è«–æ™‚ã«å®‰å…¨ã«ä½¿ç”¨å¯èƒ½**ã§ã€æ¬ æå€¤ã«ã‚ˆã‚‹äºˆæ¸¬ã‚¨ãƒ©ãƒ¼ã¯ç™ºç”Ÿã—ã¾ã›ã‚“ã€‚

---

**æ›´æ–°æ—¥æ™‚**: 2025-12-15  
**ãƒ‡ãƒ¼ã‚¿ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: v10_leakfix  
**ç·ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°**: 2,816,319è¡Œ
