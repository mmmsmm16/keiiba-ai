# 競馬AI – ROI向上についてアドバイスほしい

## 何やってるか

JRA中央競馬で、AIで予測して馬券買って**回収率100%超え**を目指してる。
現状、検証データでは101.7%出てるけど、ベット数が少なすぎて実用性に難あり。

---

## データ

### ソース
- **JV-LINK** (JRA公式データ)
- 過去レース結果、馬・騎手・調教師情報など全部入り
- 2019〜2025年の約6年分

### 特徴量（約293次元）

こんな感じのを使ってる:

| カテゴリ | 例 |
|----------|-----|
| 馬の過去成績 | 勝率、複勝率、連対率（直近5走/全体） |
| 距離適性 | この距離での過去成績 |
| コース適性 | 競馬場×芝/ダートの成績 |
| 騎手・調教師 | 勝率、リーディング、馬との相性 |
| 血統 | 父/母父の距離・コース適性 |
| レース情報 | 馬場状態、枠番、頭数 |
| 市場情報 | オッズ、人気順 |

---

## モデル

### アルゴリズム
- **LightGBM** (勾配ブースティング)
- GPU使えてない（新しすぎるGPUで未対応）、CPUで回してる

### 作ったモデル

| モデル | 何を予測 | 説明 |
|--------|----------|------|
| **Binary** | 1位になるか (0/1) | 単勝向き |
| **Top2** | 2位以内か (0/1) | |
| **Top3** | 3位以内か (0/1) | 複勝向き |
| **Blend** | 0.4×Binary + 0.6×Top3 | 混ぜたやつ、これが一番良かった |
| **LambdaRank** | 順位ラベル (1-5着) | ランキング学習、微妙だった |

### 精度

| 指標 | Binary | Top3 | Blend |
|------|--------|------|-------|
| AUC | 0.75-0.78 | 0.72-0.75 | 0.76 |
| LogLoss | 0.25-0.30 | - | - |
| ECE (確率のズレ) | **0.004** ← かなり良い | - | - |
| Top1当たる率 | 22-26% | - | 22.8% |

### 学習方法
- 2019-2022で学習 → 2023で検証
- 5-Fold CVもやった、似たような結果

---

## 試した戦略

### 戦略A: Win-Confident（単勝、厳選型）

これが一番ROI出た。

```
モデル: Blend
馬券: 単勝

条件:
  ① 予測確率1位の馬の確率 >= 28%
  ② 1位と2位の確率差 >= 12%（「明確に本命」なレース）
  ③ オッズ 2〜15倍
  ④ 期待値 (確率×オッズ) >= 1.8

結果 (2023年):
  ベット: 167回/年（1日平均0.5回くらい）
  当たり: 38回
  的中率: 22.8%
  ROI: 101.7%
```

問題は**ベット少なすぎ**。月14回しか賭けないのに、そのうち当たるの3回。

### 戦略B: Dynamic-EV-Max（EV重視、広めに見る）

Top1だけじゃなくて、上位N頭の中でEVが一番高い馬を選ぶやつ。

```
ロジック:
  1位と2位の確率差(分離度)を見て、混戦なら広く見る
  
  spread <= 3%: N=5頭から選ぶ（混戦）
  spread <= 10%: N=4頭
  spread <= 15%: N=3頭
  それ以上: N=2頭（本命明確）
  
  その中で EV >= 閾値 の馬を選んで、EV最大にベット

結果 (2023年, Blend):
  ベット: 2,615回/年
  的中率: 7.8%
  ROI: 82.2%
```

ベット数は増えたけど、的中率下がりすぎてROI落ちた。

### 戦略C: Place-Stable（複勝、安定型）

```
モデル: Binary
馬券: 複勝（3着以内）

条件:
  ① 予測1位の確率 >= 30%
  ② 出走頭数 <= 16頭

結果 (2023年):
  ベット: 177回/年
  的中率: 48.0%
  ROI: 86.4%
```

的中率は高いけど、ROIが100%届かない。

### 戦略D: Exacta-Flow（馬単流し）

```
モデル: Binary
馬券: 馬単（1着固定で2着をTop2/Top3に流す）

条件:
  ① 予測1位の確率 >= 30%
  ② 分離度 >= 12%

ベット: 2点（1着:Top1 → 2着:Top2 or Top3）

結果 (2023年):
  ベット: 1,450点/年（725レース×2点）
  的中率: 8.5%
  ROI: 81.4%
```

---

## 全モデル×全戦略の結果（上位）

2023年検証データ:

| モデル | 戦略 | ベット数 | 的中率 | ROI |
|--------|------|---------|--------|-----|
| **Blend** | **Win-Confident** | 167 | 22.8% | **101.7%** |
| Blend | Win-Confident (緩め) | 272 | 24.3% | 93.3% |
| Binary | Place-Stable | 177 | 48.0% | 86.4% |
| Blend | Dynamic-EV-Max | 2,615 | 7.8% | 82.2% |
| Binary | Exacta-Flow | 1,450 | 8.5% | 81.4% |
| Top3 | Win-Confident | 425 | 21.4% | 81.0% |

---

## やってみた工夫

### モデル側

| 試したこと | 結果 |
|-----------|------|
| LambdaRank (順位学習) | イマイチ、Binaryより悪い |
| Binary + Top3 のブレンド | 効果あり、Blendが最強 |
| 特徴量追加いろいろ | 微改善程度 |
| ハイパーパラメータ調整 | まだやってない |

### 戦略側

| 試したこと | 結果 |
|-----------|------|
| EV閾値で絞る | ROI上がるけどベット減る |
| 分離度フィルタ | 本命レース選別に有効 |
| 動的Top N + EV最大 | ベット増えるけどROI落ちる |
| 1レース1ベット原則 | 過剰ベット防止に有効 |

---

## 今困ってること

### 1. ROIと実用性のトレードオフ

| 戦略 | ROI | ベット/年 | 月平均 | 問題 |
|------|-----|----------|--------|------|
| Win-Confident | 101.7% | 167 | 14回 | 少なすぎ、連敗きつい |
| Dynamic-EV-Max | 82.2% | 2,615 | 218回 | ROI足りない |

**22.8%の的中率 = 4〜5回に1回当たる計算**
→ 10連敗とか普通にありえる
→ 実運用でメンタル持たない

### 2. 予測精度の限界？

- AUC 0.76 くらいで頭打ち感ある
- キャリブレーション (ECE=0.004) は良い = 「確率30%と予測したら、実際30%くらい当たる」
- でも識別力が限界 = 「どの馬が来るか」の予測がそこまで正確じゃない

### 3. EV重視の罠

- 「EV高い馬を選ぶ」= オッズ高い馬を選びやすい
- オッズ高い = 人気ない = 的中率低い
- 結果、的中率さらに下がってROI期待値は上がっても分散がでかい

---

## 聞きたいこと

### Q1: 予測精度
- AUC 0.76 → 0.80以上に上げる方法ってある？
- 競馬特有の効く特徴量とかある？
- Transformerとか別のモデル使うべき？

### Q2: 戦略
- ROI 100%維持しつつベット数増やせない？
- 単勝と複勝組み合わせたりとかどう？
- Kelly基準とか資金管理使うべき？

### Q3: リスク管理
- 連敗怖い。どう対処すればいい？
- バックテストと実運用でどれくらいズレる？

---

## 参考

### 関連コード
- `scripts/run_strategy_simulation.py` – 戦略シミュレーション
- `scripts/run_t2_cv_experiment.py` – モデル学習
- `src/preprocessing/` – 特徴量作成

### データ
- JRA公式データ (JV-LINK)
- 2019-2023年（学習+検証）
- 年間約3,500レース
