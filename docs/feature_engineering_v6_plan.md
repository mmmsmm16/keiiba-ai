# Feature Engineering 2.0 (Model v6) 計画書

## 概要
Feature Engineering 2.0では、従来の「個々の馬の過去成績」中心の特徴量から脱却し、**「関係性 (Interaction)」と「文脈 (Context)」** を捉える特徴量を導入します。これにより、単純な能力比較では説明できないレースの綾（パル）や、暗黙知として語られる「騎手適性」「馬場適性」のモデル化を目指します。

## 1. カテゴリ変数の高度化 (High-Dimensional Embeddings)

騎手(200+)、調教師(200+)、種牡馬(500+) などの高次元カテゴリ変数は、従来のLabel EncodingやOne-Hot Encodingでは情報が希薄化します。これらを密なベクトル表現（Embedding）に変換することで、似た特性を持つ騎手や血統をモデルが学習できるようにします。

### アプローチ
*   **Neural Network (TabNet) 向け**:
    *   PyTorchの `nn.Embedding` 層を使用し、学習プロセスの中で最適なベクトル表現を獲得させます。
    *   例: ルメール騎手と川田騎手のベクトル距離が近づき、新人騎手とは離れるような表現が自動獲得されます。
*   **Tree Model (LGBM/CatBoost) 向け**:
    *   **Target Encoding (TE)**: 「その騎手が過去に乗った馬の平均勝率・回収率」等を特徴量化。リークを防ぐため、K-Fold TEやSmoothingを適用します。
    *   **Entity Embedding**: ニューラルネットワークで学習したEmbeddingベクトルを、そのままLightGBMの入力特徴量として転用する（Transfer Learning）手法も検討します。

## 2. クロス・コンテキスト特徴量 (Interaction & Context)

「この馬は強いか？」ではなく**「この条件でこの馬は強いか？」** を問う特徴量を作成します。

### 主なアイデア
*   **騎手 × コース**: 単なるリーディング順位ではなく、「中山芝2500mが得意な騎手か？」という詳細な適性。
*   **種牡馬 × 距離/馬場**: 「ディープインパクト産駒は芝・中距離」のような傾向を数値化。
*   **調教師 × 騎手**: 「勝負気配」を感じさせる黄金タッグ（例: 堀厩舎×ムーア騎手）のフラグ。
*   **トラックバイアス (Track Bias)**:
    *   **当日傾向**: 同日のこれまでのレース結果から、「逃げ馬の勝率」「内枠の勝率」等を集計し、そのレースに適用。
    *   注意点: 推論時は「そのレースより前の時間帯のレース」のみを使用する厳密な時系列管理が必要。

## 3. レース展開とペース (Race Dynamics)

個々の馬だけでなく、**「メンバー構成」** から展開を予測し、特徴量化します。

### 主なアイデア
*   **逃げ馬密度 (Pace Pressure)**: メンバー中に「前走逃げた馬」が何頭いるか。多いほどハイペースになり、差し馬有利になる傾向をモデル化。
*   **同型馬フラグ**: 自分と同じ脚質の馬が近くの枠にいるか（ポジション争いの激化）。
*   **展開有利度**: 予測された展開（ハイ/スロー）に対し、その馬の脚質がマッチしているかを数値化。

## 4. 時系列・トレンド (Time Series Analysis)

「過去の平均」ではなく**「直近の変化」** に注目します。

### 主なアイデア
*   **モメンタム**: 近5走のスピード指数や着順の推移について線形回帰を行い、その「傾き（Slope）」を特徴量とする（上昇トレンドか、下降トレンドか）。
*   **昇級・降級の壁**: 単純なクラス変数だけでなく、昇級初戦の馬の過去成績（下級条件での圧勝度）と、現クラスの平均レベルとのギャップを数値化。

## 5. 実装ロードマップ

| Step | タスク | 期待効果 |
| :--- | :--- | :--- |
| **Step 1** | **Embedding実装** | TabNet精度の向上、騎手/血統要素の反映 |
| **Step 2** | **Target Encoding洗練** | LightGBM/CatBoostの精度向上 |
| **Step 3** | **展開/ペース特徴量** | 展開依存のデータの予測精度向上 |
| **Step 4** | **トラックバイアス** | 当日の馬場状態への適応力強化 |
| **Step 5** | **特徴量削減 (Selection)** | 計算コスト削減、過学習防止 |

この計画に基づき、`src/pipeline/data.py` および特徴量エンジニアリングモジュール (`src/features/`) の拡張を進めていきます。
